services:
  consultas-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: consultas-remotas-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080

      # SQL Server Config (substitua pelos valores reais)
      # Disponibilizar variáveis base dentro do container (fallback de credenciais)
      - SQL_USER=${SQL_USER}
      - SQL_PASSWORD=${SQL_PASSWORD}
      - SQL_USER_APS=${SQL_USER_APS}
      - SQL_PASSWORD_APS=${SQL_PASSWORD_APS}

      - SqlServer__Servers__0__User=${SQL_USER}
      - SqlServer__Servers__0__Password=${SQL_PASSWORD}

      # Azure AD Config
      - AzureAd__TenantId=${AZURE_TENANT_ID}
      - AzureAd__ClientId=${AZURE_CLIENT_ID}
      - AzureAd__ClientSecret=${AZURE_CLIENT_SECRET}

      # SharePoint Config
      - SharePoint__SiteId=${SHAREPOINT_SITE_ID}
      - SharePoint__DriveId=${SHAREPOINT_DRIVE_ID}

      # Performance tuning
      - DOTNET_gcServer=1
      - DOTNET_GCHeapHardLimit=2000000000

    volumes:
      - ./logs:/app/logs
      - ./static:/app/wwwroot
    networks:
      - consultas-network

    # Limites de recursos (ajuste conforme necessário)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  consultas-network:
    driver: bridge

volumes:
  logs:
